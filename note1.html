
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>note</title>

    <link rel="stylesheet" href="1140.css">
    <link rel="stylesheet" href="common.css">

</head>

<body>
    <div id="container" class="container12">
        <div class="row">
            <div class="column12">
                <h1>消息发送的设计</h1>
                <p></p>
            </div>
        </div>
        <div class="row">
            <div class="column12">
                <p>目前的设计，已经涉及的问题：</p>

                <div class="ubuntuMono" style="white-space: pre;">

1. 消息统一存入数据库
2. 定时器定时拉取待发送的数据，开启线程发送
3. 消息发送后，状态改变

最大的一个问题就是定时器会重复处理同一条数据


待发送的消息：
    ┌───┬──────────────────────────────────────────────┬────────┐
    │ 1 │ 您的套餐xxx将于xxx到期，请尽快处理           │ 待发送 │
    ├───┼──────────────────────────────────────────────┼────────┤
    │ 2 │ 您预约的套餐xxx将于xxx小时后开始，请注意时间 │ 待发送 │
    └───┴──────────────────────────────────────────────┴────────┘

此时，我们有两条待发送的消息，在我们的时间线上，程序执行如下：


    ┌───────────┐
    │ 定时器    │
    ├───────────┤
    │ 5分钟一次 │
    └───────────┘

    ┬──────────┬──────────┬──────────┬
    10:00      10:05      10:10
    

    10:00 

    ┌────────────┐      ┌────────────┐
    │ 消息状态   │      │ 线程池     │     
    ├───┬────────┤      ├────────────┤
    │ 1 │ 待发送 │      │ 无         │   
    │ 2 │ 待发送 │      └────────────┘
    └───┴────────┘      
        
    ┌────────────┐---------------->    ┌──────────────────────┐
    │ 待发送消息 │开启线程1            │ 线程1                │
    ├────────────┤                     ├──────────────────────┤     
    │ 消息1      │                     │ 循环发送消息         │
    │ 消息2      │                     └──────────────────────┘
    └────────────┘                                          
        
    10:05

    ┌────────────┐      ┌────────────┐
    │ 消息状态   │      │ 线程池     │    
    ├───┬────────┤      ├────────────┤
    │ 1 │ 已发送 │      │ 线程1      │
    │ 2 │ 待发送 │      └────────────┘
    └───┴────────┘

    
    ┌────────────┐---------------->    ┌──────────────────────┐
    │ 待发送消息 │开启线程2            │ 线程2                │
    ├────────────┤                     ├──────────────────────┤     
    │ 消息1      │                     │ 循环发送消息         │
    │ 消息2      │                     └──────────────────────┘
    └────────────┘                                          
                </div>


            </div>
        </div>

    </div>
</body>

</html>
